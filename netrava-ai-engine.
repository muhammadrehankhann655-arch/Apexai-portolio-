import time
from flask import Flask, request, jsonify

app = Flask(__name__)

# üõ°Ô∏è MASTER SECURITY: Ye tere clients ka database hai
# Isme 'usage' aur 'active' status track hoga
CLIENTS = {
    "JIO_9921_PROD": {
        "name": "Jio Reliance Official", 
        "active": True, 
        "usage": 0,
        "tier": "Enterprise"
    },
    "TRIAL_USER": {
        "name": "Beta Tester", 
        "active": True, 
        "usage": 0,
        "tier": "Free"
    }
}

# üß† NETRAVA INTELLIGENT ROUTING
# Jo sawal yahan hain, wo 0.001ms mein solve honge (Internet ka kharcha 0)
LOCAL_BRAIN = {
    "hi": "Netrava Edge: Hello! System is online and secure.",
    "status": "Netrava Engine is running at 100% efficiency.",
    "who are you": "I am Netrava AI, running on local edge logic.",
    "help": "I can process 1 million queries without using cloud bandwidth."
}

@app.route('/')
def home():
    return "Netrava AI Engine is LIVE. Security: Active."

@app.route('/v1/netrava-ai', methods=['POST'])
def netrava_engine():
    start_time = time.perf_counter()
    
    # 1. SECURITY CHECK: Bina API Key ke koi nahi ghus sakta
    api_key = request.headers.get("X-Netrava-Key")
    
    if not api_key or api_key not in CLIENTS:
        return jsonify({"status": "Error", "message": "Unauthorized Access Detected"}), 401
    
    if not CLIENTS[api_key]["active"]:
        return jsonify({"status": "Error", "message": "Account Deactivated"}), 403

    # 2. DATA PROCESSING
    try:
        data = request.get_json()
        query = data.get("query", "").lower().strip()
    except:
        return jsonify({"status": "Error", "message": "Invalid Request Format"}), 400

    # 3. ROUTING LOGIC (The "Magic" part)
    CLIENTS[api_key]["usage"] += 1
    
    if query in LOCAL_BRAIN:
        # LOCAL MODE: Fast & Free
        response = LOCAL_BRAIN[query]
        mode = "LOCAL_EDGE_COMPUTE"
        cost_saved = "100%"
    else:
        # CLOUD MODE: High Power
        response = "Complex Intent Detected: Routing to Secure Cloud Node..."
        mode = "CLOUD_ROUTING_ACTIVE"
        cost_saved = "0%"

    # 4. PERFORMANCE MEASUREMENT
    latency = (time.perf_counter() - start_time) * 1000
    
    return jsonify({
        "status": "Success",
        "netrava_reply": response,
        "meta": {
            "mode": mode,
            "latency": f"{latency:.4f}ms",
            "cost_saving": cost_saved,
            "total_usage": CLIENTS[api_key]["usage"],
            "client": CLIENTS[api_key]["name"]
        }
    })

if __name__ == '__main__':
    # Production settings
    app.run(host='0.0.0.0', port=5000)
